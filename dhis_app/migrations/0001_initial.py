# Generated by Django 4.2.7 on 2025-09-23 09:24

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='DHIS2Instance',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('base_url', models.URLField()),
                ('username', models.CharField(max_length=100)),
                ('password', models.CharField(max_length=255)),
                ('version', models.CharField(blank=True, help_text='Version DHIS2 (ex: 2.38, 2.40)', max_length=20, null=True)),
                ('is_source', models.BooleanField(default=False)),
                ('is_destination', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='MetadataType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('api_endpoint', models.CharField(max_length=100)),
                ('is_active', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='SyncConfiguration',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('sync_type', models.CharField(choices=[('metadata', 'Métadonnées'), ('data', 'Données Agrégées'), ('events', 'Événements'), ('tracker', 'Données Tracker'), ('both', 'Métadonnées et Données Agrégées'), ('all_data', 'Toutes les Données'), ('complete', 'Synchronisation Complète')], default='metadata', max_length=20)),
                ('data_type', models.CharField(choices=[('aggregate', 'Données Agrégées'), ('events', 'Événements'), ('tracker', 'Données Tracker')], default='aggregate', help_text="Type de données à synchroniser (applicable quand sync_type inclut 'data')", max_length=20)),
                ('is_active', models.BooleanField(default=True)),
                ('schedule_enabled', models.BooleanField(default=False)),
                ('schedule_interval', models.IntegerField(default=60, help_text='Intervalle en minutes')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
                ('destination_instance', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='destination_configs', to='dhis_app.dhis2instance')),
                ('source_instance', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='source_configs', to='dhis_app.dhis2instance')),
            ],
        ),
        migrations.CreateModel(
            name='SyncJob',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('job_type', models.CharField(choices=[('complete', 'Job Complet'), ('metadata', 'Métadonnées'), ('data', 'Données'), ('aggregate', 'Données Agrégées'), ('events', 'Événements'), ('tracker', 'Données Tracker'), ('all_data', 'Toutes Données')], default='complete', help_text='Type spécialisé de ce job', max_length=20)),
                ('status', models.CharField(choices=[('pending', 'En attente'), ('running', 'En cours'), ('completed', 'Terminé'), ('completed_with_warnings', 'Terminé avec avertissements'), ('failed', 'Échoué'), ('cancelled', 'Annulé'), ('retrying', 'Nouvelle tentative'), ('failed_permanently', 'Échec définitif')], default='pending', max_length=30)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('progress', models.IntegerField(default=0)),
                ('total_items', models.IntegerField(default=0)),
                ('processed_items', models.IntegerField(default=0)),
                ('success_count', models.IntegerField(default=0)),
                ('error_count', models.IntegerField(default=0)),
                ('warning_count', models.IntegerField(default=0)),
                ('log_message', models.TextField(blank=True)),
                ('retry_count', models.IntegerField(default=0)),
                ('max_retries', models.IntegerField(default=3)),
                ('last_error', models.TextField(blank=True, null=True)),
                ('next_retry_at', models.DateTimeField(blank=True, null=True)),
                ('is_retry', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('parent_job', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='retry_jobs', to='dhis_app.syncjob')),
                ('sync_config', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='jobs', to='dhis_app.syncconfiguration')),
            ],
        ),
        migrations.CreateModel(
            name='DHIS2EntityVersion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('dhis2_version', models.CharField(help_text='Version DHIS2 (ex: 2.38, 2.40)', max_length=20)),
                ('entity_type', models.CharField(choices=[('periodTypes', 'Period Types'), ('userRoles', 'User Roles'), ('users', 'Users'), ('userGroups', 'User Groups'), ('categoryOptions', 'Category Options'), ('categories', 'Categories'), ('categoryCombos', 'Category Combos'), ('categoryOptionCombos', 'Category Option Combos'), ('indicatorTypes', 'Indicator Types'), ('organisationUnitLevels', 'Organisation Unit Levels'), ('organisationUnits', 'Organisation Units'), ('organisationUnitGroups', 'Organisation Unit Groups'), ('organisationUnitGroupSets', 'Organisation Unit Group Sets'), ('optionSets', 'Option Sets'), ('options', 'Options'), ('dataElementGroups', 'Data Element Groups'), ('dataElementGroupSets', 'Data Element Group Sets'), ('dataElements', 'Data Elements'), ('dataElementOperands', 'Data Element Operands'), ('indicatorGroups', 'Indicator Groups'), ('indicatorGroupSets', 'Indicator Group Sets'), ('indicators', 'Indicators'), ('dataSets', 'Data Sets'), ('dataSetElements', 'Data Set Elements'), ('dataInputPeriods', 'Data Input Periods'), ('trackedEntityTypes', 'Tracked Entity Types'), ('trackedEntityAttributes', 'Tracked Entity Attributes'), ('trackedEntityAttributeGroups', 'Tracked Entity Attribute Groups'), ('trackedEntityInstances', 'Tracked Entity Instances'), ('programs', 'Programs'), ('programStages', 'Program Stages'), ('programStageDataElements', 'Program Stage Data Elements'), ('programDataElements', 'Program Data Elements'), ('programIndicators', 'Program Indicators'), ('programRules', 'Program Rules'), ('programRuleVariables', 'Program Rule Variables'), ('programRuleActions', 'Program Rule Actions'), ('validationRules', 'Validation Rules'), ('validationRuleGroups', 'Validation Rule Groups'), ('predictors', 'Predictors'), ('predictorGroups', 'Predictor Groups'), ('legendSets', 'Legend Sets'), ('legends', 'Legends'), ('charts', 'Charts'), ('reports', 'Reports'), ('reportTables', 'Report Tables'), ('maps', 'Maps'), ('visualizations', 'Visualizations'), ('eventCharts', 'Event Charts'), ('eventReports', 'Event Reports'), ('dashboards', 'Dashboards'), ('attributes', 'Attributes'), ('constants', 'Constants'), ('documents', 'Documents'), ('interpretations', 'Interpretations'), ('messageConversations', 'Message Conversations')], max_length=50)),
                ('api_endpoint', models.CharField(help_text='Endpoint API pour cette entité dans cette version', max_length=100)),
                ('api_path', models.CharField(blank=True, help_text="Chemin API complet si différent de l'endpoint", max_length=200, null=True)),
                ('supported_fields', models.JSONField(default=list, help_text='Liste des champs supportés pour cette entité dans cette version')),
                ('required_fields', models.JSONField(default=list, help_text='Liste des champs obligatoires pour cette entité dans cette version')),
                ('deprecated_fields', models.JSONField(default=list, help_text='Liste des champs dépréciés dans cette version')),
                ('new_fields', models.JSONField(default=list, help_text='Liste des nouveaux champs introduits dans cette version')),
                ('max_page_size', models.IntegerField(default=50, help_text='Taille maximale de page pour cette entité')),
                ('supports_paging', models.BooleanField(default=True, help_text='Cette entité supporte-t-elle la pagination')),
                ('supports_bulk_import', models.BooleanField(default=True, help_text="Support de l'import en lot")),
                ('supports_upsert', models.BooleanField(default=True, help_text="Support de l'upsert (insertion/mise à jour)")),
                ('import_strategy', models.CharField(choices=[('CREATE', 'Création seulement'), ('UPDATE', 'Mise à jour seulement'), ('CREATE_AND_UPDATE', 'Création et mise à jour'), ('DELETE', 'Suppression')], default='CREATE_AND_UPDATE', max_length=20)),
                ('validation_rules', models.JSONField(blank=True, default=dict, help_text='Règles de validation spécifiques à cette version')),
                ('is_active', models.BooleanField(default=True)),
                ('notes', models.TextField(blank=True, help_text='Notes sur les particularités de cette version')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['dhis2_version', 'entity_type'],
                'indexes': [models.Index(fields=['dhis2_version', 'entity_type'], name='dhis_app_dh_dhis2_v_932995_idx'), models.Index(fields=['is_active'], name='dhis_app_dh_is_acti_bb875a_idx')],
                'unique_together': {('dhis2_version', 'entity_type')},
            },
        ),
        migrations.CreateModel(
            name='AutoSyncSettings',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_enabled', models.BooleanField(default=False, help_text='Activer la synchronisation automatique')),
                ('check_interval', models.IntegerField(default=300, help_text='Intervalle de vérification en secondes (min: 60s)')),
                ('immediate_sync', models.BooleanField(default=True, help_text='Déclencher la synchronisation immédiatement après détection')),
                ('delay_before_sync', models.IntegerField(default=30, help_text='Délai avant synchronisation en secondes')),
                ('high_frequency_mode', models.BooleanField(default=False, help_text='Activer le monitoring haute fréquence (30s)')),
                ('high_frequency_interval', models.IntegerField(default=30, help_text='Intervalle en haute fréquence (secondes)')),
                ('high_frequency_resources', models.JSONField(blank=True, default=list, help_text='Ressources spécifiques en haute fréquence (organisationUnits, dataElements, etc.)')),
                ('monitor_metadata', models.BooleanField(default=True)),
                ('monitor_data_values', models.BooleanField(default=True)),
                ('metadata_resources', models.JSONField(blank=True, default=list, help_text='Liste des ressources métadonnées à surveiller')),
                ('exclude_resources', models.JSONField(blank=True, default=list, help_text='Ressources à exclure de la surveillance')),
                ('max_sync_per_hour', models.IntegerField(default=10, help_text='Nombre maximum de synchronisations par heure')),
                ('cooldown_after_error', models.IntegerField(default=1800, help_text="Délai d'attente après erreur en secondes")),
                ('notify_on_change', models.BooleanField(default=True)),
                ('notify_on_sync_start', models.BooleanField(default=False)),
                ('notify_on_sync_complete', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('sync_config', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='auto_sync_settings', to='dhis_app.syncconfiguration')),
            ],
        ),
        migrations.CreateModel(
            name='DHIS2Entity',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('entity_type', models.CharField(choices=[('periodTypes', 'Period Types'), ('userRoles', 'User Roles'), ('users', 'Users'), ('userGroups', 'User Groups'), ('categoryOptions', 'Category Options'), ('categories', 'Categories'), ('categoryCombos', 'Category Combos'), ('categoryOptionCombos', 'Category Option Combos'), ('indicatorTypes', 'Indicator Types'), ('organisationUnitLevels', 'Organisation Unit Levels'), ('organisationUnits', 'Organisation Units'), ('organisationUnitGroups', 'Organisation Unit Groups'), ('organisationUnitGroupSets', 'Organisation Unit Group Sets'), ('optionSets', 'Option Sets'), ('options', 'Options'), ('dataElementGroups', 'Data Element Groups'), ('dataElementGroupSets', 'Data Element Group Sets'), ('dataElements', 'Data Elements'), ('dataElementOperands', 'Data Element Operands'), ('indicatorGroups', 'Indicator Groups'), ('indicatorGroupSets', 'Indicator Group Sets'), ('indicators', 'Indicators'), ('dataSets', 'Data Sets'), ('dataSetElements', 'Data Set Elements'), ('dataInputPeriods', 'Data Input Periods'), ('trackedEntityTypes', 'Tracked Entity Types'), ('trackedEntityAttributes', 'Tracked Entity Attributes'), ('trackedEntityAttributeGroups', 'Tracked Entity Attribute Groups'), ('trackedEntityInstances', 'Tracked Entity Instances'), ('programs', 'Programs'), ('programStages', 'Program Stages'), ('programStageDataElements', 'Program Stage Data Elements'), ('programDataElements', 'Program Data Elements'), ('programIndicators', 'Program Indicators'), ('programRules', 'Program Rules'), ('programRuleVariables', 'Program Rule Variables'), ('programRuleActions', 'Program Rule Actions'), ('validationRules', 'Validation Rules'), ('validationRuleGroups', 'Validation Rule Groups'), ('predictors', 'Predictors'), ('predictorGroups', 'Predictor Groups'), ('legendSets', 'Legend Sets'), ('legends', 'Legends'), ('charts', 'Charts'), ('reports', 'Reports'), ('reportTables', 'Report Tables'), ('maps', 'Maps'), ('visualizations', 'Visualizations'), ('eventCharts', 'Event Charts'), ('eventReports', 'Event Reports'), ('dashboards', 'Dashboards'), ('attributes', 'Attributes'), ('constants', 'Constants'), ('documents', 'Documents'), ('interpretations', 'Interpretations'), ('messageConversations', 'Message Conversations')], max_length=50)),
                ('dhis2_uid', models.CharField(help_text="UID DHIS2 de l'objet", max_length=11)),
                ('name', models.CharField(max_length=255)),
                ('display_name', models.CharField(blank=True, max_length=255, null=True)),
                ('short_name', models.CharField(blank=True, max_length=50, null=True)),
                ('code', models.CharField(blank=True, max_length=50, null=True)),
                ('is_selected', models.BooleanField(default=True, help_text='Inclure dans la synchronisation')),
                ('import_order', models.IntegerField(help_text="Ordre d'import basé sur les dépendances")),
                ('last_synchronized', models.DateTimeField(blank=True, null=True)),
                ('sync_status', models.CharField(choices=[('pending', 'En attente'), ('success', 'Synchronisé'), ('failed', 'Échec'), ('skipped', 'Ignoré')], default='pending', max_length=20)),
                ('sync_error_message', models.TextField(blank=True, null=True)),
                ('full_data', models.JSONField(blank=True, help_text="Données complètes de l'objet depuis DHIS2", null=True)),
                ('field_mapping', models.JSONField(blank=True, default=dict, help_text='Mapping des champs entre les versions source et destination (source_field: destination_field)')),
                ('data_transformations', models.JSONField(blank=True, default=dict, help_text='Transformations de données nécessaires lors de la synchronisation')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('destination_version_info', models.ForeignKey(blank=True, help_text="Informations de version pour l'instance destination", null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='destination_entities', to='dhis_app.dhis2entityversion')),
                ('source_version_info', models.ForeignKey(blank=True, help_text="Informations de version pour l'instance source", null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='source_entities', to='dhis_app.dhis2entityversion')),
                ('sync_config', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='entities', to='dhis_app.syncconfiguration')),
            ],
            options={
                'ordering': ['import_order', 'name'],
                'indexes': [models.Index(fields=['sync_config', 'entity_type'], name='dhis_app_dh_sync_co_4696c2_idx'), models.Index(fields=['import_order'], name='dhis_app_dh_import__386ccb_idx'), models.Index(fields=['is_selected'], name='dhis_app_dh_is_sele_6d3cbf_idx')],
                'unique_together': {('sync_config', 'entity_type', 'dhis2_uid')},
            },
        ),
    ]
