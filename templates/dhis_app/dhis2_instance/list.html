{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}{{ title|default:"Instances DHIS2" }}{% endblock %}

{% block page_actions %}
<a href="{% url 'dhis2_instance_create' %}" class="btn btn-primary">
    <i class="fas fa-plus mr-2"></i>Nouvelle Instance
</a>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="space-y-6">
    {% if instances %}
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <ul class="divide-y divide-gray-200">
                {% for instance in instances %}
                    <li>
                        <div class="px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center min-w-0 flex-1">
                                <div class="flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="fas fa-server text-blue-600"></i>
                                    </div>
                                </div>
                                <div class="min-w-0 flex-1 ml-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-medium text-gray-900 truncate">
                                                <a href="{% url 'dhis2_instance_detail' instance.id %}" class="hover:text-blue-600">
                                                    {{ instance.name }}
                                                </a>
                                            </h3>
                                            <p class="text-sm text-gray-500 truncate">
                                                {{ instance.base_url }}
                                            </p>
                                            <div class="flex items-center space-x-2 mt-1">
                                                {% if instance.version %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                        v{{ instance.version }}
                                                    </span>
                                                {% endif %}
                                                {% if instance.is_source %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        Source
                                                    </span>
                                                {% endif %}
                                                {% if instance.is_destination %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        Destination
                                                    </span>
                                                {% endif %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if instance.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                    {% if instance.is_active %}
                                                        <i class="fas fa-check-circle mr-1"></i>Actif
                                                    {% else %}
                                                        <i class="fas fa-times-circle mr-1"></i>Inactif
                                                    {% endif %}
                                                </span>
                                                <span id="connection-status-{{ instance.id }}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                    {% if instance.connection_status == True %}bg-green-100 text-green-800
                                                    {% elif instance.connection_status == False %}bg-red-100 text-red-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {% if instance.connection_status == True %}
                                                        <i class="fas fa-wifi mr-1"></i>Connecté
                                                    {% elif instance.connection_status == False %}
                                                        <i class="fas fa-wifi-slash mr-1"></i>Déconnecté
                                                    {% else %}
                                                        <i class="fas fa-question-circle mr-1"></i>Non testé
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="testConnection({{ instance.id }})" class="text-gray-400 hover:text-blue-600" title="Tester la connexion">
                                                <i class="fas fa-plug"></i>
                                            </button>
                                            <a href="{% url 'dhis2_instance_detail' instance.id %}" class="text-gray-400 hover:text-blue-600" title="Voir les détails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'dhis2_instance_edit' instance.id %}" class="text-gray-400 hover:text-green-600" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                {{ instances|length }} instance{{ instances|length|pluralize }}
            </div>
        </div>
    {% else %}
        <div class="text-center py-12">
            <div class="text-gray-400">
                <i class="fas fa-server text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Aucune instance DHIS2</h3>
                <p class="text-gray-500 mb-6">Commencez par ajouter votre première instance DHIS2.</p>
                <a href="{% url 'dhis2_instance_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Ajouter une Instance
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales pour gérer les vérifications
let connectionCheckInProgress = false;

// Fonction pour obtenir le token CSRF
function getCSRFToken() {
    // Méthode 1: Chercher dans les inputs (formulaires)
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput && csrfInput.value) {
        return csrfInput.value;
    }

    // Méthode 2: Chercher dans les méta-balises
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta && csrfMeta.content) {
        return csrfMeta.content;
    }

    // Méthode 3: Chercher dans les cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken' && value) {
            return value;
        }
    }

    console.warn('Token CSRF non trouvé dans les inputs, méta-balises ou cookies');
    return '';
}

// Fonction pour vérifier toutes les instances
function checkAllInstancesStatus() {
    if (connectionCheckInProgress) {
        console.log('Vérification déjà en cours...');
        return;
    }

    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        console.error('Impossible de récupérer le token CSRF - vérification annulée');
        return;
    }

    connectionCheckInProgress = true;
    console.log('Vérification automatique des statuts des instances...');

    // Afficher un indicateur discret de vérification
    showConnectionCheckIndicator();

    fetch('{% url "dhis2_instance_bulk_status_check" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => response.json())
    .then(data => {
        connectionCheckInProgress = false;
        hideConnectionCheckIndicator();

        if (data.success) {
            console.log(`Vérification terminée: ${data.total_checked} instances vérifiées, ${data.updated_count} mises à jour`);

            // Mettre à jour l'affichage des statuts
            updateConnectionStatuses(data.results);

            // Afficher une notification si des instances ont changé
            if (data.updated_count > 0) {
                showStatusUpdateNotification(data.updated_instances);
            }
        } else {
            console.error('Erreur lors de la vérification:', data.message);
        }
    })
    .catch(error => {
        connectionCheckInProgress = false;
        hideConnectionCheckIndicator();
        console.error('Erreur de réseau lors de la vérification des statuts:', error);
    });
}

// Afficher un indicateur de vérification en cours
function showConnectionCheckIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'connection-check-indicator';
    indicator.className = 'fixed top-4 left-4 z-40 bg-blue-100 border border-blue-300 text-blue-800 px-3 py-2 rounded-lg shadow-md flex items-center';
    indicator.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Vérification des connexions...
    `;
    document.body.appendChild(indicator);
}

// Masquer l'indicateur de vérification
function hideConnectionCheckIndicator() {
    const indicator = document.getElementById('connection-check-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// Mettre à jour l'affichage des statuts de connexion
function updateConnectionStatuses(results) {
    results.forEach(result => {
        const statusElement = document.getElementById(`connection-status-${result.id}`);
        if (statusElement) {
            // Mettre à jour le contenu du badge de statut
            let statusClass, statusIcon, statusText;

            if (result.status) {
                statusClass = 'bg-green-100 text-green-800';
                statusIcon = 'fas fa-wifi';
                statusText = 'Connecté';
            } else {
                statusClass = 'bg-red-100 text-red-800';
                statusIcon = 'fas fa-wifi-slash';
                statusText = 'Déconnecté';
            }

            statusElement.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
            statusElement.innerHTML = `<i class="${statusIcon} mr-1"></i>${statusText}`;

            // Animation de mise à jour si le statut a changé
            if (result.updated) {
                statusElement.classList.add('animate-pulse');
                setTimeout(() => {
                    statusElement.classList.remove('animate-pulse');
                }, 2000);
            }
        }
    });
}

// Afficher une notification pour les changements de statut
function showStatusUpdateNotification(updatedInstances) {
    const connectionsGained = updatedInstances.filter(i => i.new_status === true).length;
    const connectionsLost = updatedInstances.filter(i => i.new_status === false).length;

    let message = 'Statuts mis à jour: ';
    const parts = [];

    if (connectionsGained > 0) {
        parts.push(`${connectionsGained} connexion${connectionsGained > 1 ? 's' : ''} rétablie${connectionsGained > 1 ? 's' : ''}`);
    }

    if (connectionsLost > 0) {
        parts.push(`${connectionsLost} connexion${connectionsLost > 1 ? 's' : ''} perdue${connectionsLost > 1 ? 's' : ''}`);
    }

    message += parts.join(', ');

    // Utiliser le système de toast existant si disponible
    if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.showToast) {
        const toastType = connectionsLost > 0 ? 'warning' : 'success';
        DHIS2Sync.showToast(message, toastType);
    } else {
        console.log(message);
    }
}

// Test de connexion individuel (fonction existante)
function testConnection(instanceId) {
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        console.error('Impossible de récupérer le token CSRF pour le test de connexion');
        if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.showToast) {
            DHIS2Sync.showToast('Erreur: Token CSRF manquant', 'error');
        }
        return;
    }

    if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.showLoading) {
        DHIS2Sync.showLoading();
    }

    fetch(`/instances/${instanceId}/test-connection/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.hideLoading) {
            DHIS2Sync.hideLoading();
        }

        if (data.success) {
            if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.showToast) {
                DHIS2Sync.showToast(`Connexion réussie: ${data.message}`, 'success');
            }

            // Mettre à jour le statut dans l'interface
            const statusElement = document.getElementById(`connection-status-${instanceId}`);
            if (statusElement) {
                statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                statusElement.innerHTML = '<i class="fas fa-wifi mr-1"></i>Connecté';
            }
        } else {
            if (typeof DHIS2Sync !== 'undefined' && DHIS2Sync.showToast) {
                DHIS2Sync.showToast(`Échec de connexion: ${data.message}`, 'error');
            }

            // Mettre à jour le statut dans l'interface
            const statusElement = document.getElementById(`connection-status-${instanceId}`);
            if (statusElement) {
                statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                statusElement.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i>Déconnecté';
            }
        }
    })
    .catch(error => {
        if (typeof DHIS2Sync !== 'undefined') {
            DHIS2Sync.hideLoading();
            DHIS2Sync.showToast('Erreur de réseau', 'error');
        }
        console.error('Erreur lors du test de connexion:', error);
    });
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page chargée - initialisation de la vérification des statuts');

    // Debug: vérifier la disponibilité du token CSRF
    const token = getCSRFToken();
    if (token) {
        console.log('Token CSRF trouvé:', token.substring(0, 10) + '...');
    } else {
        console.error('Aucun token CSRF disponible');
        return; // Ne pas lancer la vérification sans token
    }

    // Vérifier les statuts au chargement de la page
    setTimeout(() => {
        checkAllInstancesStatus();
    }, 1000); // Attendre 1 seconde pour laisser le temps à la page de se charger

    console.log('Vérification automatique des statuts des instances initialisée');
});

// Optionnel: Vérification périodique (toutes les 5 minutes)
// Décommentez les lignes suivantes si vous voulez une vérification automatique périodique
/*
setInterval(() => {
    if (!connectionCheckInProgress) {
        checkAllInstancesStatus();
    }
}, 5 * 60 * 1000); // 5 minutes
*/
</script>
{% endblock %}
